Here is the general algorithm for primality testing which handles Carmichael numbers. The algorithm is essentially the same as before with one small observation. I'll explain the algorithm using an example. Let's consider the example of 1,729, this is a composite number, in fact, it's a Carmichael number. So our previous algorithm, is unlikely to detect that is compiler. Now, let's first recall our previous approach. We first choose a random number Z between one and 1,728. For concreteness and simplicity, let's suppose that Z is five, I chose a small number to make it simpler. Now, our previous approach takes these numbers Z, which is five, and we raise it to the power of 1,728, which is X minus one, and we take that mod 1,729, which is X. So, we look at Z raised to the power X minus one mod X. Now, if this is not one, then we have a proof that this number is composite. Well, since this is a Carmichael number, this is unlikely to work and in fact it doesn't work. Five raised to the power of 1,728 is congruent to one, mod 1,729. So, firmus test fails in this case. Well, let's go back and look at how we compute five raised to this power. Well of course, we do use repeated squaring. Now, in the spirit of repeated squaring, let's take this number 1,728 and let's take out all the factors of two that we can. Now, notice that this number is even Y, while this number X, we're checking whether it's prime or not. So, it's odd and therefore X minus one is even or 1,728 is equal to two times 864, we take out another factor of two and repeat. We can do it six times, so we get two to the six times 27. We stop when we reach an odd number. Let's start a new approach by computing five raised to the power 27 mod 1,729. Now of course, this exponent might be very large, so of course, we're going to use the fast modular exponentiation algorithm to compute it. Suppose we ran it, and we computed this exponent, it turns out it's congruent to 1,217. Now, let's apply repeated squaring six times to get to this result. So let's take this result and square it. So, we're computing five to the power 54, and we're doing this mod X. So we take the previous results squared, and that's congruent to 1,065 mod X, then we take this previous result and we square it, and it turns out that 1,065 squared is congruent to one mod X. Now, we continue, of course once we get one it's going to continue one, so the next result will be one squared which is one of course, and we square it again and we're going to get one again. We do it a few more times, and eventually we get to five raised to the power, two to the six times 27, and that will be one, which we know from before, mod 1,729. Now, let's look backwards. So, we end with one here, we get this string of ones. Let's look at the first number which is different from one, what do we know about it? In this case, it's 1,065 but 1,065 squared is one mod X. Since 1,065 squared is one mod X therefore, 1,065 is a square root of one mod X. In fact, it's what we call a non-trivial square root of one mod X. Why is it non-trivial? What are trivial squared roots of one mod X? Well, the trivial square roots of one mod X are one and minus one. Why? Well, we always know that one squared is one and negative one squared is one. That's true in real arithmetic and it's also true in modular arithmetic. So, every number X has these two trivial square roots of one mod X. It turns out that prime numbers X only have these two square roots of one mod X. So, one and minus one are the only two square roots of one mod X when X is prime. But if we can show a non-trivial square root of one mod X then therefore, that implies that X is composite because prime numbers only have the trivial ones. So, if we show a non-trivial one, that proves that X is composite. In this case, we've shown that this number X has a non-trivial square root of one, namely 1,065. It turns out that for a composite number X, even if it's Carmichael for at least three quarters of the choices of Z, this algorithm works. Namely, if we compute Z raised to the power X minus one mod X and if we get one and we go backwards in this approach, so we use this repeated squaring and then we work backwards from the one to the first non-one, this leads to a non-trivial square root of one mod X, and therefore, proves that X is composite and this works for at least three quarters of the choices of Z. Now, the mathematics for proving that at least three quarters of the choices of Z work is quite complicated but the algorithm itself that we're using here is basically the same as before with the repeated squaring added in. So, to deal with Carmichael numbers, we use basically the same algorithm as before, except when formats test fails, we go back and we check whether we get a non-trivial square root of one mod X.